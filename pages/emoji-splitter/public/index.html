<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light">
  <title>Emoji Splitter · 表情包切割工具</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=Fraunces:opsz,wght,SOFT@9..144,300..900,0..100&family=Spline+Sans+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --paper: #f7f1e3;
      --paper-2: #fff8ec;
      --ink: #15110c;
      --ink-2: rgba(21, 17, 12, 0.74);
      --ink-3: rgba(21, 17, 12, 0.52);
      --line: rgba(21, 17, 12, 0.14);
      --shadow: rgba(21, 17, 12, 0.18);

      --accent: #ff4d00;
      --accent-2: #15b097;
      --accent-3: #2b50ff;

      --ok: #147a4a;
      --err: #c0262d;
      --info: #1d4ed8;

      --radius-xl: 28px;
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 12px;

      --mono: "Spline Sans Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: "Atkinson Hyperlegible", ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
      --display: "Fraunces", ui-serif, Georgia, serif;

      --noise: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      color: var(--ink);
      font-family: var(--sans);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(255, 77, 0, 0.16), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(21, 176, 151, 0.16), transparent 55%),
        radial-gradient(900px 800px at 55% 95%, rgba(43, 80, 255, 0.12), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper-2));
      overflow-x: hidden;
    }

    body::before{
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.08;
      background-image: var(--noise);
      background-size: 220px 220px;
      mix-blend-mode: multiply;
      z-index: 0;
    }

    body::after{
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        repeating-linear-gradient(0deg, rgba(21, 17, 12, 0.06) 0 1px, transparent 1px 18px),
        repeating-linear-gradient(90deg, rgba(21, 17, 12, 0.05) 0 1px, transparent 1px 18px);
      opacity: 0.55;
      z-index: 0;
    }

    a{ color: inherit; }
    .hidden{ display: none !important; }

    .wrap{
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 18px 42px;
    }

    .topbar{
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 18px;
      padding: 18px 18px 16px;
      border: 1px solid var(--line);
      border-radius: var(--radius-xl);
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.68), rgba(255, 255, 255, 0.48));
      box-shadow:
        0 18px 60px rgba(21, 17, 12, 0.08),
        0 2px 0 rgba(255, 255, 255, 0.7) inset;
      backdrop-filter: blur(10px);
    }

    .brand{
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 0;
    }

    .mark{
      width: 46px;
      height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(21, 17, 12, 0.16);
      background:
        radial-gradient(16px 16px at 30% 28%, rgba(255, 255, 255, 0.9), transparent 62%),
        linear-gradient(135deg, rgba(255, 77, 0, 0.95), rgba(43, 80, 255, 0.92));
      box-shadow:
        0 16px 26px rgba(21, 17, 12, 0.16),
        0 2px 0 rgba(255, 255, 255, 0.6) inset;
      position: relative;
      overflow: hidden;
      flex: 0 0 auto;
    }

    .mark::after{
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(from 210deg, rgba(255,255,255,0.0), rgba(255,255,255,0.62), rgba(255,255,255,0.0));
      animation: sweep 7.8s linear infinite;
      opacity: 0.55;
    }

    @keyframes sweep{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(360deg); }
    }

    .title{
      margin: 0;
      font-family: var(--display);
      font-weight: 820;
      letter-spacing: -0.02em;
      font-size: clamp(22px, 2.4vw, 30px);
      line-height: 1.05;
    }

    .subtitle{
      margin: 6px 0 0;
      color: var(--ink-2);
      font-size: 14px;
      line-height: 1.4;
      max-width: 58ch;
    }

    .steps{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(21, 17, 12, 0.14);
      background: rgba(255, 255, 255, 0.55);
      color: var(--ink-2);
      font-size: 12px;
      letter-spacing: 0.02em;
      user-select: none;
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.65) inset;
    }

    .chip b{
      font-family: var(--mono);
      font-weight: 600;
      color: var(--ink);
    }

    .grid{
      margin-top: 18px;
      display: grid;
      gap: 18px;
      align-items: start;
      grid-template-columns: 1fr;
    }

    .grid.has-workspace{
      grid-template-columns: 460px 1fr;
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius-xl);
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.76), rgba(255, 255, 255, 0.52));
      box-shadow:
        0 22px 80px rgba(21, 17, 12, 0.10),
        0 2px 0 rgba(255, 255, 255, 0.72) inset;
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .card-head{
      padding: 18px 18px 0;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
    }

    .h2{
      margin: 0;
      font-family: var(--display);
      font-weight: 760;
      letter-spacing: -0.02em;
      font-size: 18px;
    }

    .meta{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--ink-2);
      font-size: 12px;
      font-family: var(--mono);
    }

    .meta span{
      padding: 6px 10px;
      border: 1px dashed rgba(21, 17, 12, 0.18);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.55);
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.65) inset;
    }

    .upload-section{
      padding: 18px;
    }

    .upload-area{
      border-radius: calc(var(--radius-xl) - 6px);
      border: 1.5px dashed rgba(21, 17, 12, 0.26);
      background:
        radial-gradient(900px 360px at 10% 0%, rgba(255, 77, 0, 0.10), transparent 62%),
        radial-gradient(640px 300px at 90% 10%, rgba(21, 176, 151, 0.12), transparent 62%),
        rgba(255, 255, 255, 0.62);
      padding: 28px 22px;
      cursor: pointer;
      min-height: 220px;
      display: grid;
      align-content: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      transition: transform 140ms ease, border-color 140ms ease, background 240ms ease, box-shadow 240ms ease;
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.65) inset,
        0 14px 40px rgba(21, 17, 12, 0.10);
    }

    .upload-area:hover{
      transform: translateY(-2px);
      border-color: rgba(21, 176, 151, 0.46);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.65) inset,
        0 18px 56px rgba(21, 17, 12, 0.14);
    }

    .upload-area.dragover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(255, 77, 0, 0.58);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.65) inset,
        0 22px 70px rgba(21, 17, 12, 0.20);
    }

    .upload-title{
      margin: 0;
      font-size: 18px;
      line-height: 1.2;
      letter-spacing: -0.01em;
      font-weight: 800;
    }

    .upload-desc{
      margin: 0;
      color: var(--ink-2);
      font-size: 13px;
      line-height: 1.5;
    }

    .upload-kbd{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
      color: var(--ink-3);
      font-size: 12px;
    }

    kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid rgba(21, 17, 12, 0.18);
      background: rgba(255, 255, 255, 0.72);
      box-shadow: 0 2px 0 rgba(21, 17, 12, 0.10);
    }

    #fileInput{ display: none; }

    .workspace-section{
      display: contents;
    }

    .preview{
      padding: 16px 18px 18px;
    }

    .preview-container{
      position: relative;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(21, 17, 12, 0.16);
      background:
        repeating-linear-gradient(45deg, rgba(21, 17, 12, 0.05) 0 10px, transparent 10px 20px),
        rgba(255, 255, 255, 0.65);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.65) inset,
        0 18px 60px rgba(21, 17, 12, 0.12);
      overflow: hidden;
      padding: 14px;
      display: flex;
      justify-content: center;
    }

    .board{
      position: relative;
      display: inline-block;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(21, 17, 12, 0.10);
      background: rgba(255, 255, 255, 0.68);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.72) inset,
        0 14px 26px rgba(21, 17, 12, 0.12);
      max-width: 100%;
    }

    .preview-canvas{
      display: block;
      border-radius: 14px;
    }

    .grid-overlay{
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: 14px;
      filter: drop-shadow(0 8px 16px rgba(21, 17, 12, 0.12));
    }

    .grid-info{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(21, 17, 12, 0.18);
      background: rgba(255, 255, 255, 0.62);
      color: var(--ink-2);
      font-size: 12px;
      line-height: 1.3;
      display: inline-flex;
      gap: 8px;
      align-items: baseline;
      font-family: var(--mono);
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.7) inset;
    }

    .grid-info strong{
      font-family: var(--sans);
      font-weight: 800;
      color: var(--ink);
    }

    .controls{
      padding: 16px 18px 18px;
      display: grid;
      gap: 12px;
    }

    .field{
      display: grid;
      gap: 8px;
    }

    .label{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
      color: var(--ink-2);
    }

    .label b{
      font-size: 13px;
      color: var(--ink);
      font-weight: 900;
      letter-spacing: -0.01em;
    }

    .input{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(21, 17, 12, 0.18);
      background: rgba(255, 255, 255, 0.74);
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.72) inset;
      font-family: var(--mono);
      font-size: 14px;
      color: var(--ink);
      outline: none;
      transition: box-shadow 160ms ease, border-color 160ms ease, transform 120ms ease;
    }

    .input:focus{
      border-color: rgba(43, 80, 255, 0.55);
      box-shadow:
        0 0 0 4px rgba(43, 80, 255, 0.18),
        0 1px 0 rgba(255, 255, 255, 0.72) inset;
    }

    .input[aria-invalid="true"]{
      border-color: rgba(192, 38, 45, 0.7);
      box-shadow:
        0 0 0 4px rgba(192, 38, 45, 0.14),
        0 1px 0 rgba(255, 255, 255, 0.72) inset;
    }

    .actions{
      margin-top: 6px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn{
      appearance: none;
      border: 1px solid rgba(21, 17, 12, 0.18);
      background: rgba(255, 255, 255, 0.72);
      color: var(--ink);
      border-radius: 16px;
      padding: 12px 12px;
      font-family: var(--sans);
      font-weight: 900;
      letter-spacing: -0.01em;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 180ms ease, background 180ms ease;
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.72) inset,
        0 12px 24px rgba(21, 17, 12, 0.10);
      user-select: none;
    }

    .btn:hover{
      transform: translateY(-1px);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.72) inset,
        0 18px 38px rgba(21, 17, 12, 0.14);
    }

    .btn:active{
      transform: translateY(0);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.72) inset,
        0 10px 20px rgba(21, 17, 12, 0.10);
    }

    .btn:disabled{
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.72) inset,
        0 12px 24px rgba(21, 17, 12, 0.08);
    }

	    .btn-primary{
	      position: relative;
	      overflow: hidden;
	      border-color: rgba(21, 17, 12, 0.32);
	      background: var(--accent);
	      color: rgba(21, 17, 12, 0.96);
	      text-shadow: none;
	      box-shadow:
	        0 1px 0 rgba(255, 255, 255, 0.22) inset,
	        0 16px 34px rgba(21, 17, 12, 0.18);
	    }

	    .btn-primary::before{
	      content: "";
	      position: absolute;
	      inset: -14px;
	      background-image:
	        radial-gradient(circle at 1px 1px, rgba(21, 17, 12, 0.26) 0 1.1px, transparent 1.1px),
	        linear-gradient(180deg, rgba(255, 255, 255, 0.24), transparent 46%);
	      background-size: 10px 10px, 100% 100%;
	      opacity: 0.38;
	      mix-blend-mode: multiply;
	      transform: rotate(-2deg);
	      pointer-events: none;
	    }

	    .btn-primary::after{
	      content: "";
	      position: absolute;
	      inset: 0;
	      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.32), transparent);
	      transform: translateX(-140%);
	      opacity: 0;
	      pointer-events: none;
	      transition: transform 520ms cubic-bezier(.2,.8,.2,1), opacity 520ms ease;
	    }

	    .btn-primary:hover{
	      box-shadow:
	        0 1px 0 rgba(255, 255, 255, 0.26) inset,
	        0 22px 52px rgba(21, 17, 12, 0.22);
	    }

	    .btn-primary:hover::after{
	      transform: translateX(140%);
	      opacity: 1;
	    }

    .hint{
      margin: 10px 0 0;
      color: var(--ink-3);
      font-size: 12px;
      line-height: 1.4;
    }

    .status{
      margin: 14px 18px 0;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(21, 17, 12, 0.18);
      background: rgba(255, 255, 255, 0.70);
      color: var(--ink);
      font-size: 13px;
      line-height: 1.35;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.72) inset;
    }

    .status::before{
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--info);
      box-shadow: 0 0 0 4px rgba(29, 78, 216, 0.14);
      flex: 0 0 auto;
    }

    .status.success::before{
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(20, 122, 74, 0.16);
    }

    .status.error::before{
      background: var(--err);
      box-shadow: 0 0 0 4px rgba(192, 38, 45, 0.14);
    }

    .loading{
      margin-left: auto;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(21, 17, 12, 0.18);
      border-top-color: rgba(21, 176, 151, 0.95);
      animation: spin 1s linear infinite;
    }

    @keyframes spin{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(360deg); }
    }

    .results{
      padding: 14px 18px 18px;
    }

    .results-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 10px;
      min-height: 120px;
    }

    .results-grid:empty::before{
      content: "等待切割结果…（上传后会自动预览）";
      display: block;
      color: var(--ink-3);
      font-size: 13px;
      padding: 14px 2px;
    }

    .emoji-item{
      position: relative;
      border-radius: 18px;
      border: 1px solid rgba(21, 17, 12, 0.16);
      background: rgba(255, 255, 255, 0.72);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.72) inset,
        0 14px 34px rgba(21, 17, 12, 0.10);
      padding: 10px;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 180ms ease, border-color 180ms ease;
      overflow: hidden;
    }

    .emoji-item::after{
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(closest-side, rgba(255, 77, 0, 0.18), transparent 60%);
      transform: translate(40%, -10%);
      opacity: 0;
      transition: opacity 220ms ease;
      pointer-events: none;
    }

    .emoji-item:hover{
      transform: translateY(-2px);
      border-color: rgba(255, 77, 0, 0.32);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.72) inset,
        0 22px 50px rgba(21, 17, 12, 0.14);
    }

    .emoji-item:hover::after{
      opacity: 1;
    }

    .emoji-thumb{
      width: 100%;
      height: 98px;
      display: block;
      object-fit: contain;
      border-radius: 14px;
      border: 1px solid rgba(21, 17, 12, 0.10);
      background:
        linear-gradient(135deg, rgba(21, 176, 151, 0.12), rgba(43, 80, 255, 0.10)),
        rgba(255, 255, 255, 0.62);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.72) inset,
        0 10px 18px rgba(21, 17, 12, 0.10);
    }

    .emoji-label{
      margin-top: 8px;
      color: var(--ink-2);
      font-size: 12px;
      line-height: 1.25;
      font-family: var(--mono);
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    .emoji-label b{
      color: var(--ink);
      font-family: var(--sans);
      font-weight: 900;
      letter-spacing: -0.01em;
      font-size: 12px;
      white-space: nowrap;
    }

    .emoji-dims{
      color: var(--ink-3);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 980px){
      .grid.has-workspace{ grid-template-columns: 1fr; }
    }

    @media (max-width: 520px){
      .topbar{
        padding: 16px 14px;
        border-radius: 22px;
      }
      .steps{ justify-content: flex-start; }
      .card{ border-radius: 22px; }
      .actions{ grid-template-columns: 1fr; }
      .results-grid{ grid-template-columns: repeat(auto-fill, minmax(132px, 1fr)); }
      .emoji-thumb{ height: 92px; }
    }

	    @media (prefers-reduced-motion: reduce){
	      .mark::after{ animation: none; }
	      .upload-area, .emoji-item, .btn{ transition: none; }
	      .btn-primary::after{ transition: none; }
	      .loading{ animation: none; }
	    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <h1 class="title">Emoji Splitter</h1>
          <p class="subtitle">把一张表情包合集切成单个小图，自动预览网格与切割结果。所有处理都在本地完成。</p>
        </div>
      </div>
      <div class="steps" aria-label="Workflow">
        <span class="chip"><b>1</b> 上传</span>
        <span class="chip"><b>2</b> 设置网格</span>
        <span class="chip"><b>3</b> 导出</span>
      </div>
    </header>

    <div class="grid">
      <section class="card upload-section" id="uploadSection">
        <div class="card-head">
          <h2 class="h2">把表情包丢进来</h2>
          <div class="meta">
            <span>JPG / PNG / GIF</span>
            <span>≤ 10MB</span>
          </div>
        </div>
        <div class="upload-area" id="uploadArea" role="button" tabindex="0" aria-label="Upload image">
          <p class="upload-title">点击选择文件，或拖拽到这里</p>
          <p class="upload-desc">上传一张包含多格表情的合集图，然后填写行数与列数。</p>
          <div class="upload-kbd">也支持粘贴图片：<kbd>Ctrl</kbd>+<kbd>V</kbd> / <kbd>⌘</kbd>+<kbd>V</kbd></div>
        </div>
        <input type="file" id="fileInput" accept="image/*">
      </section>

      <section class="workspace-section hidden" id="workspaceSection">
        <section class="card">
          <div class="card-head">
            <h2 class="h2">切割板</h2>
            <div class="meta" id="fileMeta" aria-live="polite"></div>
          </div>
          <div class="preview">
            <div class="preview-container" id="previewContainer">
              <div class="board" id="board">
                <canvas id="previewCanvas" class="preview-canvas"></canvas>
                <canvas id="gridCanvas" class="grid-overlay"></canvas>
              </div>
            </div>
            <div id="gridInfo" class="grid-info hidden">
              <strong>网格</strong>
              <span id="gridDimensions"></span>
            </div>
          </div>

          <div class="controls">
            <div class="field">
              <div class="label"><b>行数</b><span>1–20</span></div>
              <input class="input" type="number" id="rowsInput" min="1" max="20" value="4" inputmode="numeric" aria-label="Rows">
            </div>
            <div class="field">
              <div class="label"><b>列数</b><span>1–20</span></div>
              <input class="input" type="number" id="colsInput" min="1" max="20" value="4" inputmode="numeric" aria-label="Columns">
            </div>
            <div class="field">
              <div class="label"><b>ZIP 文件名</b><span>可选</span></div>
              <input class="input" type="text" id="zipNameInput" placeholder="例如：my-emojis_2025-12-13" aria-label="ZIP filename">
            </div>
            <div class="actions">
              <button class="btn btn-primary" id="downloadBtn">打包导出 ZIP</button>
              <button class="btn" id="resetBtn">重新上传</button>
            </div>
            <p class="hint">小技巧：点击右侧任意单个表情可直接下载 PNG。</p>
          </div>
        </section>

        <section class="card">
          <div class="card-head">
            <h2 class="h2">切割预览</h2>
            <div class="meta" id="resultsMeta"></div>
          </div>
          <div id="status" class="status hidden" role="status" aria-live="polite"></div>
          <div class="results" aria-label="Results">
            <div class="results-grid" id="resultsGrid"></div>
          </div>
        </section>
      </section>
    </div>
  </div>

  <!-- External libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    class EmojiSplitter {
      constructor() {
        this.originalImage = null;
        this.originalFile = null;
        this.splitImages = [];

        this.initializeElements();
        this.bindEvents();
        this.refreshWorkflowChips();
      }

      initializeElements() {
        this.gridWrap = document.querySelector('.grid');
        this.uploadArea = document.getElementById('uploadArea');
        this.fileInput = document.getElementById('fileInput');
        this.uploadSection = document.getElementById('uploadSection');
        this.workspaceSection = document.getElementById('workspaceSection');

        this.previewCanvas = document.getElementById('previewCanvas');
        this.gridCanvas = document.getElementById('gridCanvas');
        this.previewContainer = document.getElementById('previewContainer');
        this.board = document.getElementById('board');

        this.rowsInput = document.getElementById('rowsInput');
        this.colsInput = document.getElementById('colsInput');
        this.zipNameInput = document.getElementById('zipNameInput');

        this.fileMeta = document.getElementById('fileMeta');
        this.resultsMeta = document.getElementById('resultsMeta');
        this.resultsGrid = document.getElementById('resultsGrid');

        this.status = document.getElementById('status');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.resetBtn = document.getElementById('resetBtn');

        this.gridInfo = document.getElementById('gridInfo');
        this.gridDimensions = document.getElementById('gridDimensions');
      }

      bindEvents() {
        this.uploadArea.addEventListener('click', () => this.fileInput.click());
        this.uploadArea.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.fileInput.click();
          }
        });
        this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

        this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));

        document.addEventListener('paste', (e) => this.handlePaste(e));
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') this.reset();
        });

        this.downloadBtn.addEventListener('click', () => this.downloadZIP());
        this.resetBtn.addEventListener('click', () => this.reset());

        const handleGridChange = debounce(() => {
          this.validateInputs();
          this.drawGridLines();
          this.splitImageAuto();
        }, 120);

        this.rowsInput.addEventListener('input', handleGridChange);
        this.colsInput.addEventListener('input', handleGridChange);

        window.addEventListener('resize', debounce(() => {
          if (!this.originalImage) return;
          this.renderPreviewCanvas();
          this.drawGridLines();
        }, 150));
      }

      refreshWorkflowChips() {
        const chips = document.querySelectorAll('.steps .chip');
        const hasImage = !!this.originalImage;
        const hasResults = this.splitImages.length > 0;

        if (chips[0]) chips[0].style.opacity = hasImage ? '0.62' : '1';
        if (chips[1]) chips[1].style.opacity = hasImage ? '1' : '0.55';
        if (chips[2]) chips[2].style.opacity = hasResults ? '1' : '0.55';
      }

      handleDragOver(e) {
        e.preventDefault();
        this.uploadArea.classList.add('dragover');
      }

      handleDragLeave(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');
      }

      handleDrop(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files && files.length > 0) this.processFile(files[0]);
      }

      handlePaste(e) {
        if (this.originalImage) return;
        const items = e.clipboardData?.items;
        if (!items) return;
        for (const item of items) {
          if (item.type && item.type.startsWith('image/')) {
            const file = item.getAsFile();
            if (file) {
              this.showStatus('检测到粘贴图片，正在读取...', 'info');
              this.processFile(file);
              break;
            }
          }
        }
      }

      handleFileSelect(e) {
        const file = e.target.files?.[0];
        if (file) this.processFile(file);
      }

      processFile(file) {
        if (!file.type.startsWith('image/')) {
          this.showStatus('请选择图片文件。', 'error');
          return;
        }
        if (file.size > 10 * 1024 * 1024) {
          this.showStatus('文件大小不能超过 10MB。', 'error');
          return;
        }

        this.originalFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            this.originalImage = img;
            this.showPreview();
            this.showStatus('图片已就绪，调整网格即可。', 'success');
          };
          img.onerror = () => this.showStatus('图片加载失败，请检查文件格式。', 'error');
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      showPreview() {
        this.uploadSection.classList.add('hidden');
        this.workspaceSection.classList.remove('hidden');
        this.gridWrap?.classList.add('has-workspace');
        this.splitImages = [];
        this.updateFileMeta();

        this.renderPreviewCanvas();
        this.drawGridLines();
        this.splitImageAuto();
        this.refreshWorkflowChips();
      }

      updateFileMeta() {
        if (!this.fileMeta) return;
        this.fileMeta.innerHTML = '';
        if (!this.originalImage || !this.originalFile) return;

        const parts = [
          `${this.originalFile.name}`,
          `${formatFileSize(this.originalFile.size)}`,
          `${this.originalImage.width}×${this.originalImage.height}px`,
        ];

        for (const text of parts) {
          const span = document.createElement('span');
          span.textContent = text;
          this.fileMeta.appendChild(span);
        }
      }

      renderPreviewCanvas() {
        if (!this.originalImage || !this.previewCanvas || !this.gridCanvas || !this.previewContainer) return;

        const containerWidth = Math.max(240, this.previewContainer.clientWidth - 28);
        const maxWidth = Math.min(640, containerWidth);
        const maxHeight = 520;

        let displayWidth = this.originalImage.width;
        let displayHeight = this.originalImage.height;

        if (displayWidth > maxWidth) {
          displayHeight = (maxWidth / displayWidth) * displayHeight;
          displayWidth = maxWidth;
        }
        if (displayHeight > maxHeight) {
          displayWidth = (maxHeight / displayHeight) * displayWidth;
          displayHeight = maxHeight;
        }

        const dpr = Math.min(2, window.devicePixelRatio || 1);

        this.previewCanvas.style.width = `${displayWidth}px`;
        this.previewCanvas.style.height = `${displayHeight}px`;
        this.previewCanvas.width = Math.floor(displayWidth * dpr);
        this.previewCanvas.height = Math.floor(displayHeight * dpr);

        const ctx = this.previewCanvas.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.clearRect(0, 0, displayWidth, displayHeight);
        ctx.drawImage(this.originalImage, 0, 0, displayWidth, displayHeight);

        this.gridCanvas.style.width = `${displayWidth}px`;
        this.gridCanvas.style.height = `${displayHeight}px`;
        this.gridCanvas.width = Math.floor(displayWidth * dpr);
        this.gridCanvas.height = Math.floor(displayHeight * dpr);
      }

      validateInputs() {
        const rows = parseInt(this.rowsInput.value, 10);
        const cols = parseInt(this.colsInput.value, 10);

        const ok = Number.isFinite(rows) && Number.isFinite(cols) && rows >= 1 && rows <= 20 && cols >= 1 && cols <= 20;
        this.rowsInput.setAttribute('aria-invalid', ok ? 'false' : 'true');
        this.colsInput.setAttribute('aria-invalid', ok ? 'false' : 'true');
        return ok;
      }

      drawGridLines() {
        if (!this.originalImage || !this.gridCanvas) return;

        const rows = parseInt(this.rowsInput.value, 10) || 1;
        const cols = parseInt(this.colsInput.value, 10) || 1;

        const dpr = Math.min(2, window.devicePixelRatio || 1);
        const displayWidth = Math.floor(this.gridCanvas.width / dpr);
        const displayHeight = Math.floor(this.gridCanvas.height / dpr);

        const ctx = this.gridCanvas.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.clearRect(0, 0, displayWidth, displayHeight);

        if (!this.validateInputs()) {
          this.gridInfo.classList.add('hidden');
          return;
        }

        const cellWidth = displayWidth / cols;
        const cellHeight = displayHeight / rows;

        ctx.strokeStyle = 'rgba(255, 77, 0, 0.85)';
        ctx.lineWidth = 1.5;
        ctx.globalAlpha = 0.95;

        for (let i = 1; i < cols; i++) {
          const x = i * cellWidth;
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, displayHeight);
          ctx.stroke();
        }

        for (let i = 1; i < rows; i++) {
          const y = i * cellHeight;
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(displayWidth, y);
          ctx.stroke();
        }

        ctx.strokeStyle = 'rgba(21, 176, 151, 0.95)';
        ctx.lineWidth = 2.5;
        ctx.strokeRect(0, 0, displayWidth, displayHeight);
        ctx.globalAlpha = 1;

        this.updateGridInfo(rows, cols);
      }

      updateGridInfo(rows, cols) {
        if (!this.originalImage || !this.validateInputs()) {
          this.gridInfo.classList.add('hidden');
          return;
        }

        this.gridInfo.classList.remove('hidden');
        const totalEmojis = rows * cols;
        const actualCellWidth = Math.floor(this.originalImage.width / cols);
        const actualCellHeight = Math.floor(this.originalImage.height / rows);
        this.gridDimensions.textContent = `${rows}行 × ${cols}列 = ${totalEmojis}个 · 每个 ${actualCellWidth}×${actualCellHeight}px`;
      }

      splitImageAuto() {
        if (!this.originalImage || !this.validateInputs()) return;

        const rows = parseInt(this.rowsInput.value, 10);
        const cols = parseInt(this.colsInput.value, 10);

        try {
          this.performSplit(rows, cols);
          this.displayResults();
          this.hideStatus();
        } catch (error) {
          this.showStatus('切割失败：' + error.message, 'error');
        }
      }

      performSplit(rows, cols) {
        this.splitImages = [];

        const imgWidth = this.originalImage.width;
        const imgHeight = this.originalImage.height;
        const cellWidth = Math.floor(imgWidth / cols);
        const cellHeight = Math.floor(imgHeight / rows);

        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const canvas = document.createElement('canvas');
            canvas.width = cellWidth;
            canvas.height = cellHeight;

            const ctx = canvas.getContext('2d');
            const srcX = col * cellWidth;
            const srcY = row * cellHeight;

            ctx.drawImage(
              this.originalImage,
              srcX, srcY, cellWidth, cellHeight,
              0, 0, cellWidth, cellHeight
            );

            this.splitImages.push({
              name: `emoji_${row + 1}_${col + 1}.png`,
              dataURL: canvas.toDataURL('image/png'),
              width: cellWidth,
              height: cellHeight,
            });
          }
        }
      }

      displayResults() {
        this.resultsGrid.innerHTML = '';

        if (this.resultsMeta) {
          this.resultsMeta.innerHTML = '';
          const span = document.createElement('span');
          span.textContent = `${this.splitImages.length} 个结果`;
          this.resultsMeta.appendChild(span);
        }

        this.splitImages.forEach((image, index) => {
          const item = document.createElement('div');
          item.className = 'emoji-item';
          item.title = '点击下载 PNG';

          const img = document.createElement('img');
          img.className = 'emoji-thumb';
          img.src = image.dataURL;
          img.alt = `Emoji ${index + 1}`;
          img.loading = 'lazy';
          img.decoding = 'async';

          const label = document.createElement('div');
          label.className = 'emoji-label';
          const left = document.createElement('b');
          left.textContent = `#${index + 1}`;
          const right = document.createElement('span');
          right.className = 'emoji-dims J_dim';
          right.textContent = `${image.width}×${image.height}px`;
          label.appendChild(left);
          label.appendChild(right);

          item.appendChild(img);
          item.appendChild(label);
          item.addEventListener('click', () => this.downloadSingle(image));

          this.resultsGrid.appendChild(item);
        });

        this.refreshWorkflowChips();
      }

      downloadSingle(image) {
        const a = document.createElement('a');
        a.href = image.dataURL;
        a.download = image.name;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      async downloadZIP() {
        if (this.splitImages.length === 0) {
          this.showStatus('没有可下载的结果。', 'error');
          return;
        }

        this.showStatus('正在打包 ZIP 文件...', 'info');
        this.downloadBtn.disabled = true;

        try {
          const zip = new JSZip();
          for (const image of this.splitImages) {
            const base64Data = image.dataURL.split(',')[1];
            const binaryData = atob(base64Data);
            const arrayBuffer = new ArrayBuffer(binaryData.length);
            const uint8Array = new Uint8Array(arrayBuffer);
            for (let i = 0; i < binaryData.length; i++) uint8Array[i] = binaryData.charCodeAt(i);
            zip.file(image.name, uint8Array, { binary: true });
          }

          const content = await zip.generateAsync({ type: 'blob' });
          let fileName = this.zipNameInput.value.trim();
          if (!fileName) {
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            fileName = `emojis_${timestamp}`;
          }
          if (!fileName.toLowerCase().endsWith('.zip')) fileName += '.zip';
          saveAs(content, fileName);

          this.showStatus('ZIP 已生成并开始下载。', 'success');
        } catch (error) {
          this.showStatus('ZIP 打包失败：' + error.message, 'error');
        } finally {
          this.downloadBtn.disabled = false;
        }
      }

      reset() {
        this.originalImage = null;
        this.originalFile = null;
        this.splitImages = [];
        this.fileInput.value = '';
        this.zipNameInput.value = '';

        this.workspaceSection.classList.add('hidden');
        this.uploadSection.classList.remove('hidden');
        this.gridWrap?.classList.remove('has-workspace');
        this.hideStatus();

        this.resultsGrid.innerHTML = '';
        if (this.fileMeta) this.fileMeta.innerHTML = '';
        if (this.resultsMeta) this.resultsMeta.innerHTML = '';

        if (this.previewCanvas) this.previewCanvas.getContext('2d')?.clearRect(0, 0, this.previewCanvas.width, this.previewCanvas.height);
        if (this.gridCanvas) this.gridCanvas.getContext('2d')?.clearRect(0, 0, this.gridCanvas.width, this.gridCanvas.height);

        this.refreshWorkflowChips();
      }

      showStatus(message, type) {
        this.status.textContent = message;
        this.status.className = `status ${type}`;
        this.status.classList.remove('hidden');

        if (type === 'info') {
          const loading = document.createElement('span');
          loading.className = 'loading';
          this.status.appendChild(loading);
        }
      }

      hideStatus() {
        this.status.classList.add('hidden');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new EmojiSplitter();
    });

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>
</body>
</html>
